{
  "version": 1,
  "source": "dofusdb",
  "entity": "spell",
  "label": "Sorts",
  "meta": { "maxId": 20000 },
  "endpoints": {
    "fetchMany": {
      "path": "/spells",
      "method": "GET",
      "queryDefaults": { "lang": "{lang}", "$limit": 100, "$skip": 0 }
    },
    "fetchSpellLevels": {
      "path": "/spell-levels",
      "method": "GET",
      "queryDefaults": { "lang": "{lang}", "$limit": 100, "$skip": 0 }
    }
  },
  "filters": {
    "supported": [
      { "key": "id", "type": "number" },
      { "key": "idMin", "type": "number" },
      { "key": "idMax", "type": "number" },
      { "key": "ids", "type": "number[]", "max": 500 },
      { "key": "name", "type": "string" },
      { "key": "breedId", "type": "number" }
    ]
  },
  "target": {
    "krosmozEntity": "spell",
    "primaryKey": { "sourceField": "id", "targetField": "dofusdb_id" },
    "autoUpdateField": "auto_update"
  },
  "notes": [
    "DofusDB ne fournit pas forcément /spells/{id}; le fetchOne peut être simulé via pagination + filtre local.",
    "Les levels peuvent être récupérés via /spell-levels et filtrés par spellId."
  ],
  "mapping": [
    {
      "key": "dofusdb_id",
      "from": { "path": "id" },
      "to": [{ "model": "spells", "field": "dofusdb_id" }],
      "formatters": [{ "name": "toString", "args": {} }]
    },
    {
      "key": "name",
      "from": { "path": "name", "langAware": true },
      "to": [{ "model": "spells", "field": "name" }],
      "formatters": [{ "name": "pickLang", "args": { "lang": "{lang}", "fallback": "fr" } }]
    },
    {
      "key": "description",
      "from": { "path": "description", "langAware": true },
      "to": [{ "model": "spells", "field": "description" }],
      "formatters": [
        { "name": "pickLang", "args": { "lang": "{lang}", "fallback": "fr" } },
        { "name": "truncate", "args": { "max": 255 } }
      ]
    },
    {
      "key": "image",
      "from": { "path": "img" },
      "to": [{ "model": "spells", "field": "image" }],
      "formatters": [{ "name": "storeScrappedImage", "args": { "entityFolder": "spells", "idPath": "id" } }]
    },
    {
      "key": "class",
      "from": { "path": "breedId" },
      "to": [{ "model": "spells", "field": "class" }],
      "formatters": [{ "name": "nullableInt", "args": {} }]
    },
    {
      "key": "cost",
      "from": { "path": "levels.0.apCost" },
      "to": [{ "model": "spells", "field": "cost" }],
      "formatters": [
        { "name": "toInt", "args": {} },
        { "name": "clampInt", "args": { "min": 0, "max": 20 } }
      ]
    },
    {
      "key": "range",
      "from": { "path": "levels.0.range" },
      "to": [{ "model": "spells", "field": "range" }],
      "formatters": [
        { "name": "toInt", "args": {} },
        { "name": "clampInt", "args": { "min": 0, "max": 50 } }
      ]
    },
    {
      "key": "area",
      "from": { "path": "levels.0.effects.0.zoneDescr.shape" },
      "to": [{ "model": "spells", "field": "area" }],
      "formatters": [
        { "name": "nullableInt", "args": {} }
      ]
    },
    {
      "key": "effects_normalized_json",
      "from": { "path": "levels.0.effects" },
      "to": [{ "model": "spells", "field": "effect" }],
      "formatters": [
        { "name": "packDofusdbEffects", "args": { "sourceType": "spell_level", "includeRaw": true, "lang": "{lang}" } },
        { "name": "jsonEncode", "args": { "pretty": false } }
      ]
    }
  ],
  "relations": {
    "summon": {
      "enabledByDefault": true,
      "maxDepth": 1,
      "strategy": "import_and_link",
      "extract": { "path": "_levels_for_summon", "summonDetector": "dofusdbInvocationDetector" },
      "targetEntity": "monster"
    }
  }
}

